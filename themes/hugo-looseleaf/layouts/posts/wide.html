{{ define "main" }}
{{- $style := resources.Get "css/_wide.scss" | toCSS (dict "outputStyle" "compressed") -}}
{{- $style_linked := $style.RelPermalink -}}
<style>
    :root {
        --title-bg-image: url("/blog/IMG_7174.jpg");
        --title-bg-height: 120px;
    }
</style>
<link rel="stylesheet" href="{{ $style_linked }}">
<div class="archive">
    <nav class="single-nav">
        <a href="/">Home</a> | 
        <a href="/about/">About</a> |
        <a href="/links/">Friends</a>  |
        <a href="/fanpage/">Fanpage</a>  

    </nav>
    <div class="title-img">
<div id="feed-reader"></div>
<script>
    const feedURL = 'https://status.cafe/users/lyin.atom';

    function timeAgo(publishedDate) {
        const now = new Date();
        const published = new Date(publishedDate);
        const diff = now - published;

        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) {
            return `${days} day${days > 1 ? 's' : ''} ago`;
        } else if (hours > 0) {
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        } else if (minutes > 0) {
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else {
            return `${seconds} second${seconds > 1 ? 's' : ''} ago`;
        }
    }

    fetch(feedURL)
        .then(response => response.text())
        .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
        .then(data => {
            const entries = data.querySelectorAll("entry");
            let html = ``;

            // 只处理第一条（最新的）mumble
            if (entries.length > 0) { // 确保有条目存在
                const el = entries[0]; // 获取第一个条目

                let rawTitle = el.querySelector("title").textContent.trim();
                // 确保正确处理 Unicode 属性，特别是对于表情符号
                let emojiMatch = rawTitle.match(/[\p{Emoji}]/gu);
                let emoji = emojiMatch ? emojiMatch.join('').replace(/[0-9]+$/, '') : '';


                let content = el.querySelector("content").textContent.trim();
                let publishedDate = el.querySelector("published").innerHTML;
                let relativeTime = timeAgo(publishedDate);

                html += `
                    <div class="statuscafe-entry">
                        <p class="statuscafe-username">
                            <span class="status-meta">
                            <span class="mumble-time">${relativeTime}</span>
                            <span class="mumble-title">${emoji} </span>
                          </span>
                          </p>
                        <p class="statuscafe-content">${content}</p>
                    </div>
                `;
            }
            
            // 缓存 feed-reader 元素
            const feedReaderElement = document.getElementById("feed-reader");
            
            // 插入内容到 DOM
            if (feedReaderElement) {
                feedReaderElement.innerHTML = html;

                // 新增一行注释提示一下
                // 调用 twemoji 解析新插入的动态内容
                if (typeof twemoji !== 'undefined') {
                    twemoji.parse(feedReaderElement, {
                        base: '{{ "/my-emojis/" | relURL }}',
                        folder: 'svg',
                        ext: '.svg'
                    });
                }
            }
        });
</script>
    </div>
    <hr class="decoration-hr">
<div class="postslist">
    <div class="post-head-wrapper-text-only">
        {{/* 定义当前页面类型 */}}
        {{- $type := .Type -}}
        {{/* 初始化一个 Scratch 存储 */}}
        {{- $scratch := newScratch -}}
        {{/* 获取所有可见的文章 */}}
        {{- $articles_cat := (where (where .Site.RegularPages "Type" $type) "Params.hidden" "!=" true) -}}
        {{/* 计算所有可见文章的总数 */}}
        {{- $articles_cat_count := len $articles_cat -}}
        {{/* 计算所有可见文章的总字数（虽然不用于展示，但保留了原有的逻辑） */}}
        {{- range $articles_cat -}}
        {{- $scratch.Add "allwordcount" .WordCount -}}
        {{- end -}}
    </div>

    <div class="content">
        {{/* 获取所有可见文章，此为不分页模式，不再使用 Paginator */}}
        {{- $pages := where (where .Site.RegularPages "Type" .Type) "Params.hidden" "!=" true -}}
        
        {{/* ===== Yearly archive: 预先计算每年的文章总数（仅包含可见文章）===== */}}
        {{- $yearlyCount := newScratch -}}
        {{- range ($pages.GroupByDate "2006") -}}
            {{- $yearlyCount.Set .Key (len .Pages) -}}
        {{- end -}}

        <div>
            {{/* 获取当前年份，用于可能的样式区分（保留了原有的逻辑） */}}
            {{- $currentYear := now.Format "2006" | int -}}
            
            {{/* 按年份分组并遍历所有文章 */}}
            {{- range $pages.GroupByDate "2006" }}
                {{- $articles_yearly := .Pages -}}
                {{/* 从预先计算的 Scratch 中获取该年份的文章总数 */}}
                {{- $articles_yearly_count := $yearlyCount.Get .Key -}}
                {{- $year := .Key | int -}}

                {{/* 只有当该年份有文章时才显示 */}}
                {{ if gt $articles_yearly_count 0 }}
                <h3 class="archive--year">
                    {{ .Key }} / {{ $articles_yearly_count }} {{ if ne $articles_cat_count 1 }}entries{{ else }}entry{{ end }}
                </h3>

                {{/* 不再区分当前年份与否，统一渲染列表（简化了原有的逻辑，如果您需要区分样式，可以恢复原有的 if/else） */}}
                <ul>
                {{- range $articles_yearly }}
                    <li>
                    <span>{{ .Date.Format "01-02" }}</span>&emsp;
                    <a href="{{ .RelPermalink }}">
                        {{ if .Draft }}{{ i18n "draft" }}{{ end }}{{ .Title }}
                    </a>
                    </li>
                {{- end }}
                </ul>
                {{ end }}
            {{ end }}
        </div>
    </div>
</div>
</div>

<hr class="decoration-hr">
{{- partial "footer.html" . -}}
{{ end }}

